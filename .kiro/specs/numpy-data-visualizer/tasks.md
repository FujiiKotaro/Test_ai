# Implementation Plan

## Overview
本実装計画は、Numpy配列ベースのデータ可視化・分析ツールの開発タスクを定義します。モジュラーアーキテクチャに基づき、6つの主要コンポーネント（DataLoader、Visualizer、Analyzer、FFTProcessor、CLIController、ErrorHandler）を段階的に実装し、最終的に統合します。

## Implementation Tasks

### 1. プロジェクト基盤とエラーハンドリング
- [x] 1.1 (P) プロジェクト構造とエラーハンドリングモジュールを構築
  - プロジェクトディレクトリ構造を作成（モジュール分離）
  - ErrorHandlerモジュールを実装（例外処理、ログ記録、エラーメッセージ生成）
  - ログファイル（visualizer.log）への記録機能を実装
  - ファイルエラー、システムエラー、例外ログ記録のハンドラを実装
  - 基本的なユニットテストを作成（エラーハンドリング動作検証）
  - _Requirements: 1.3, 6.3, 7.3, 7.4_

### 2. データ読み込みモジュール
- [ ] 2.1 (P) Numpy配列ファイル読み込み機能を実装
  - .npy/.npzファイルの読み込み機能を実装（np.load使用）
  - ファイル存在チェックとエラーハンドリングを実装
  - 配列形状と次元の検証機能を実装（1D/2D/3D対応）
  - .npz複数配列の識別保持機能を実装（辞書形式）
  - 1次元配列の最適化処理を実装
  - 大規模データ（100万要素）の読み込みパフォーマンステスト（5秒以内）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 7.1_

- [ ] 2.2* (P) DataLoaderのテストカバレッジを拡充
  - 正常系テスト（.npy、.npz、1D/2D/3D配列）
  - 異常系テスト（ファイル不存在、無効形式、メモリ不足シミュレーション）
  - エラーハンドリング統合テスト（ErrorHandlerとの連携）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

### 3. グラフ可視化モジュール - 基本機能
- [ ] 3.1 基本可視化エンジンとインタラクティブバックエンドを構築
  - Matplotlibインタラクティブバックエンド自動選択を実装（Qt5Agg、TkAgg優先）
  - Figure/Axes生成の基盤を実装
  - グラフタイトル、軸ラベル、凡例設定機能を実装
  - グラフスタイル設定（色、線種、マーカー）を実装
  - _Requirements: 2.3, 2.4, 2.5_

- [ ] 3.2 (P) 1次元データ可視化機能を実装
  - 折れ線グラフ生成機能を実装
  - 棒グラフ生成機能を実装
  - 散布図生成機能を実装
  - ヒストグラム生成機能を実装
  - データ次元と可視化タイプの互換性検証を実装
  - _Requirements: 2.1, 3.1, 3.2, 3.3_

- [ ] 3.3 (P) 2次元データ可視化機能を実装
  - ヒートマップ生成機能を実装
  - 散布図（2D）生成機能を実装
  - 3Dサーフェスプロット生成機能を実装
  - 互換性チェックと代替案提示機能を実装
  - _Requirements: 2.2, 3.1, 3.2, 3.3_

### 4. グラフ可視化モジュール - 高度機能
- [ ] 4.1 (P) サブプロットとエクスポート機能を実装
  - サブプロット配置機能を実装（nrows×ncols）
  - PNG/SVG/PDF形式のエクスポート機能を実装
  - ファイル書き込みエラーハンドリングを実装
  - _Requirements: 3.4, 3.5_

- [ ] 4.2 インタラクティブ機能を実装
  - ズーム機能を実装（マウスホイール、領域選択）
  - パン機能を実装（ドラッグ移動）
  - ツールチップ機能を実装（mplcursorsまたはアノテーション）
  - 表示リセット機能を実装（Home/Reset）
  - インタラクティブバックエンドが利用不可時のフォールバック処理
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 4.3 (P) 振幅スペクトル描画機能を実装
  - 周波数（横軸）vs 振幅（縦軸）のプロット機能を実装
  - 周波数範囲設定機能を実装
  - 対数スケール表示オプションを実装
  - FFTProcessorとの統合インターフェースを実装
  - _Requirements: 8.4, 8.5, 8.6, 8.7_

- [ ] 4.4* (P) Visualizerのテストカバレッジを拡充
  - 6種類の可視化タイプの描画テスト
  - サブプロット、エクスポート機能テスト
  - インタラクティブ機能の動作確認（手動テスト推奨）
  - データ次元互換性検証のユニットテスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 5.1, 5.2, 5.3, 5.4, 5.5_

### 5. データ分析モジュール
- [ ] 5.1 (P) 統計分析機能を実装
  - 基本統計量計算を実装（平均、中央値、標準偏差、最小値、最大値）
  - 分布特性計算を実装（歪度、尖度 - scipy.stats使用）
  - 欠損値・NaN値検出機能を実装
  - 分析結果のフォーマット出力を実装
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 5.2 (P) 相関分析と結果出力機能を実装
  - 2次元データの相関行列計算を実装
  - 相関行列のヒートマップ可視化を実装（Visualizerと連携）
  - テキスト形式（.txt）での分析結果出力を実装
  - CSV形式での分析結果出力を実装
  - 2次元制約の検証とエラーメッセージを実装
  - _Requirements: 4.4, 4.5_

- [ ] 5.3* (P) Analyzerのテストカバレッジを拡充
  - 統計計算の正確性テスト（既知データでの検証）
  - NaN/欠損値検出テスト
  - 相関行列計算テスト
  - 出力ファイルフォーマット検証
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

### 6. FFT処理モジュール
- [ ] 6.1 (P) FFTエンジンとデータ前処理を実装
  - データ範囲切り抜き機能を実装（start:end指定）
  - ゼロパディング機能を実装（scipy.fft.next_fast_len使用）
  - ウィンドウ関数適用を実装（ハニング、ハミング、ブラックマン）
  - ユーザー指定可能なパディングサイズとウィンドウタイプ
  - _Requirements: 8.2, 8.3_

- [ ] 6.2 FFT実行と振幅スペクトル計算を実装
  - scipy.fft.rfftによるFFT実行を実装
  - 振幅スペクトル計算を実装（np.abs）
  - 周波数軸生成を実装（scipy.fft.rfftfreq）
  - サンプリングレート対応を実装
  - 1次元データ制約の検証とエラーメッセージを実装
  - データ範囲未指定時のデフォルト動作（データ全体FFT）
  - _Requirements: 8.1, 8.4, 8.8_

- [ ] 6.3* (P) FFTProcessorのテストカバレッジを拡充
  - FFT計算の正確性テスト（既知信号での検証）
  - ウィンドウ関数適用テスト
  - ゼロパディング動作テスト
  - 周波数軸生成の正確性テスト
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.8_

### 7. CLIコントローラとワークフロー
- [ ] 7.1 CLI引数解析とヘルプシステムを実装
  - argparseによる引数解析を実装
  - ファイルパス、可視化タイプ、FFTオプション等の引数定義
  - 引数なし時のヘルプメッセージ表示を実装
  - 無効引数時のエラーとヘルプ表示を実装
  - 引数検証とデフォルト値設定を実装
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 7.2 インタラクティブモードを実装
  - メニューベースUIを実装（シンプルなinput()ループ）
  - データ読み込み、可視化、分析、FFTの各機能をメニューから選択可能に
  - メニュー間の遷移とワークフロー制御
  - 終了オプションとエラーハンドリング
  - _Requirements: 6.4_

- [ ] 7.3 設定管理と進捗表示を実装
  - 設定の保存・復元機能を実装（JSON形式、~/.numpy_visualizer_config.json）
  - 操作履歴の記録機能を実装
  - 処理進捗表示を実装（大規模データ処理時）
  - 自動保存機能を実装（異常終了検出時 - signal.signal使用）
  - 設定ファイルスキーマ検証を実装
  - _Requirements: 6.5, 7.2, 7.5_

- [ ] 7.4 メインワークフロー統合を実装
  - CLIモードの実行フローを実装（引数 → DataLoader → Visualizer/Analyzer/FFTProcessor）
  - インタラクティブモードの実行フローを実装
  - 各モジュールとの統合インターフェース
  - エラー発生時の処理継続または安全終了
  - メモリ不足時の安全終了処理
  - _Requirements: 7.3_

- [ ] 7.5* (P) CLIControllerのテストカバレッジを拡充
  - 引数解析テスト（正常系、異常系）
  - 設定保存・復元テスト
  - ワークフロー統合テスト（各モジュールとの連携）
  - エラーハンドリング統合テスト
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 7.2, 7.3, 7.5_

### 8. 統合テストとE2Eシナリオ
- [ ] 8.1 データ読み込みと可視化の統合テスト
  - DataLoader → Visualizer フローの統合テスト
  - 各可視化タイプでのエンドツーエンドテスト
  - エラーハンドリングフローのテスト（ファイル不存在等）
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.5_

- [ ] 8.2 FFT処理フローの統合テスト
  - DataLoader → FFTProcessor → Visualizer フローの統合テスト
  - 範囲指定、パディング、ウィンドウ関数の組み合わせテスト
  - 振幅スペクトル描画のエンドツーエンドテスト
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8_

- [ ] 8.3 統計分析フローの統合テスト
  - DataLoader → Analyzer → 結果出力フローの統合テスト
  - 相関行列計算と可視化の統合テスト
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 8.4 CLIモードのE2Eテスト
  - コマンドライン引数モードでの各機能実行テスト
  - `python visualizer.py data.npy --plot line` 等のシナリオテスト
  - ヘルプ表示、エラーメッセージ表示のテスト
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 8.5 インタラクティブモードのE2Eテスト
  - メニュー選択による各機能実行テスト
  - 設定保存・復元のテスト
  - ユーザーワークフローの総合テスト
  - _Requirements: 6.4, 6.5_

### 9. パフォーマンスと品質検証
- [ ] 9.1 パフォーマンステストとベンチマーク
  - 大規模データ読み込みテスト（100万要素、5秒以内）
  - FFT処理パフォーマンステスト（10万要素、2秒以内目標）
  - 複数サブプロット生成のパフォーマンステスト
  - メモリ使用量測定（100万要素で500MB以下目標）
  - _Requirements: 7.1_

- [ ] 9.2 最終品質検証とドキュメント整備
  - 全要件カバレッジの検証（Requirements Traceability確認）
  - エラーハンドリングの網羅性確認
  - ユーザードキュメント作成（README.md、使用例）
  - 依存ライブラリのバージョン確認とrequirements.txt作成
  - コードレビューとリファクタリング
  - _Requirements: すべて_

## Implementation Notes

### 並列実行可能なタスク（Pマーク付き）
以下のタスクは独立して並列実行可能：
- 1.1: エラーハンドリングモジュール（他モジュールの基盤）
- 2.1, 2.2: DataLoader実装とテスト（他モジュールと独立）
- 3.2, 3.3: 1D/2D可視化機能（基盤3.1完了後、互いに独立）
- 4.1, 4.3: サブプロット/エクスポートと振幅スペクトル描画（基盤3.1完了後、互いに独立）
- 4.4, 5.1, 5.2, 5.3, 6.1, 6.3, 7.5: 各モジュールのテストカバレッジ拡充（実装完了後、互いに独立）

### 順次実行が必要なタスク
- 3.1 → 3.2, 3.3: 基本可視化エンジンが基盤として必要
- 4.2: インタラクティブ機能は3.1の基盤に依存
- 6.1 → 6.2: FFTエンジンはデータ前処理完了後
- 7.1 → 7.2 → 7.3 → 7.4: CLIコントローラは段階的に構築
- 8.x: 統合テストは全モジュール実装完了後

### オプションマーク（*）付きタスク
以下のタスクはMVP後に延期可能なテストカバレッジ拡充：
- 2.2, 4.4, 5.3, 6.3, 7.5: 各モジュールのテストカバレッジ拡充
- これらは既に実装時に基本的なテストを含んでおり、追加の網羅的テストとして位置づけ

## Task Summary
- **Major Tasks**: 9タスク
- **Sub-tasks**: 29サブタスク
- **Requirements Coverage**: 全要件（1.1-8.8）をカバー
- **Average Task Size**: 1-3時間/サブタスク
- **Optional Tasks**: 5サブタスク（テストカバレッジ拡充）
